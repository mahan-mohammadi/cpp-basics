code needs refactoring but it should work ok